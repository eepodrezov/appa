#!/bin/sh
. "$(dirname "$0")/_/husky.sh"

echo "Checking tests coverage (blocking for push)..."
if [ -f "coverage/coverage-summary.json" ]; then
  node -e "
    const coverage = require('./coverage/coverage-summary.json');
    const thresholds = { statements: 80, branches: 80, functions: 80, lines: 80 };
    
    for (const [metric, threshold] of Object.entries(thresholds)) {
      const actual = coverage.total[metric].pct;
      if (actual < threshold) {
        console.error(\`Coverage for \${metric} is \${actual}%, which is below the threshold of \${threshold}%\`);
        process.exit(1);
      }
    }
    
    console.log('Coverage check passed!');
  "
  
  if [ $? -ne 0 ]; then
    echo "Test coverage check failed. Push aborted."
    exit 1
  fi
else
  echo "No coverage report found. Running tests..."
  npm run test:coverage
  if [ $? -ne 0 ]; then
    echo "Tests failed. Push aborted."
    exit 1
  fi
fi

echo "All checks passed!."